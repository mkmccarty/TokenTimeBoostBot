name: Auto-merge JSON Updates
on:
  pull_request_target:
    types: [opened, synchronize, reopened]
    paths:
      - 'data/token-complaints.json'

jobs:
  auto-merge:
    runs-on: ubuntu-latest
    # Added logic to check for both renegadeEgg AND mutilis
    if: |
      github.actor == 'renegadeEgg' || 
      github.actor == 'mutilis'
    
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Verify only the specific file was changed
        id: check_files
        run: |
          # Get list of changed files between the base and the PR head
          # We use origin/main as the reference point for the diff
          git fetch origin ${{ github.event.pull_request.base.ref }}
          CHANGED_FILES=$(git diff --name-only origin/${{ github.event.pull_request.base.ref }}...HEAD)
          
          echo "Files changed: $CHANGED_FILES"
          
          # Check if the list of changed files is exactly our target file
          if [ "$CHANGED_FILES" = "data/token-complaints.json" ]; then
            echo "MATCH=true" >> $GITHUB_OUTPUT
          else
            echo "Security Check: PR contains changes to files other than the allowed JSON. Skipping auto-merge."
            exit 1
          fi

      - name: Auto-merge PR
        if: steps.check_files.outputs.MATCH == 'true'
        uses: pascalgn/automerge-action@v0.16.4
        env:
          GITHUB_TOKEN: "${{ secrets.GITHUB_TOKEN }}"
          MERGE_METHOD: "merge"
          MERGE_FILTER_AUTHOR: "" # We handle author filtering in the 'if' condition above
